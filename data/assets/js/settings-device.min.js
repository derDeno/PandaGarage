let alertSavedDevice,deviceNameField,deviceLanguageSelect,diagnoseBtn,sensorUnitSelect,sensorUpdateInterval,sensorThresholdTemp,sensorThresholdHumidity,sensorThresholdLight,externalSetCheckbox,externalSensorGroup,externalSensorSelect,buzzerSetCheckbox,buzzerGroup,buzzerTuneSelect,buzzerPlayBtn,buzzerOpeningCheckbox,buzzerClosingCheckbox,accessLoggingCheckbox,debugLoggingCheckbox,saveBtn,resetBtn,modalReset,modalInstance,modalCloseBtn,resetModalBtn;document.addEventListener("DOMContentLoaded",init);const savedToken=localStorage.getItem("token");async function init(){cacheElements(),bindEvents(),initModal(),await loadSettings()}function cacheElements(){alertSavedDevice=document.getElementById("alert-saved-device"),deviceNameField=document.getElementById("pref-device-name"),deviceLanguageSelect=document.getElementById("pref-device-language"),diagnoseBtn=document.getElementById("btn-diagnose"),sensorUnitSelect=document.getElementById("pref-device-sensor-unit"),sensorUpdateInterval=document.getElementById("pref-device-sensor-update"),sensorThresholdTemp=document.getElementById("pref-device-threshold-temp"),sensorThresholdHumidity=document.getElementById("pref-device-threshold-hum"),sensorThresholdLight=document.getElementById("pref-device-threshold-lux"),externalSetCheckbox=document.getElementById("pref-device-sensor-external-set"),externalSensorGroup=document.getElementById("pref-device-sensor-external-group"),externalSensorSelect=document.getElementById("pref-device-sensor-external"),buzzerSetCheckbox=document.getElementById("pref-device-buzzer-set"),buzzerGroup=document.getElementById("pref-device-buzzer-group"),buzzerTuneSelect=document.getElementById("pref-device-buzzer-tune"),buzzerPlayBtn=document.getElementById("btn-buzzer-play"),buzzerOpeningCheckbox=document.getElementById("pref-device-buzzer-opening"),buzzerClosingCheckbox=document.getElementById("pref-device-buzzer-closing"),accessLoggingCheckbox=document.getElementById("pref-device-access-logging"),debugLoggingCheckbox=document.getElementById("pref-device-debug-logging"),saveBtn=document.getElementById("btn-save"),resetBtn=document.getElementById("btn-reset"),modalReset=document.getElementById("modal-reset"),modalCloseBtn=document.getElementById("btn-modal-close"),resetModalBtn=document.getElementById("btn-reset-modal"),alertSavedDevice.style.display="none"}function bindEvents(){saveBtn.addEventListener("click",handleSave),diagnoseBtn.addEventListener("click",downloadDiagnose),deviceLanguageSelect.addEventListener("change",changeLanguage),externalSetCheckbox.addEventListener("change",toggleExternalSensor),buzzerSetCheckbox.addEventListener("change",toggleBuzzerSet),buzzerPlayBtn.addEventListener("click",buzzerPlay),resetBtn.addEventListener("click",showResetModal),modalCloseBtn.addEventListener("click",(()=>modalInstance.hide())),resetModalBtn.addEventListener("click",handleReset)}function initModal(){modalInstance=new bootstrap.Modal(modalReset,{backdrop:"static",keyboard:!1})}async function loadSettings(){try{const e=await fetch("/api/settings/device",{headers:{Authorization:savedToken}}),t=await e.json();deviceNameField.value=t.name||"",deviceLanguageSelect.value=t.lang||"en",sensorUnitSelect.value=(t.tempUnit??0).toString(),sensorUpdateInterval.value=t.sensorUpdateInterval??6e5,sensorThresholdTemp.value=t.thresholdTemp??0,sensorThresholdHumidity.value=t.thresholdHumidity??0,sensorThresholdLight.value=t.thresholdLight??0,externalSetCheckbox.checked=Boolean(t.externalSensorSet),toggleExternalSensor(),externalSensorSelect.value=(t.externalSensor??0).toString(),buzzerSetCheckbox.checked=Boolean(t.buzzerSet),toggleBuzzerSet(),buzzerTuneSelect.value=(t.buzzerTune??0).toString(),buzzerOpeningCheckbox.checked=Boolean(t.buzzerOpening),buzzerClosingCheckbox.checked=Boolean(t.buzzerClosing),accessLoggingCheckbox.checked=Boolean(t.logAccess),debugLoggingCheckbox.checked=Boolean(t.logDebug)}catch(e){console.error("Error loading device settings:",e)}}function toggleExternalSensor(){externalSetCheckbox.checked?externalSensorGroup.style.display="block":externalSensorGroup.style.display="none"}function toggleBuzzerSet(){buzzerSetCheckbox.checked?buzzerGroup.style.display="block":buzzerGroup.style.display="none"}async function buzzerPlay(e){e.preventDefault();const t=buzzerTuneSelect.value,n=new URLSearchParams({tune:t});if(t>0)try{if(!(await fetch("/api/buzzer/play",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:savedToken},body:n})).ok)return void console.error("Play failed")}catch(e){console.error("Error playing tune: ",e)}else console.warn("No tune selected for buzzer play")}async function handleSave(e){e.preventDefault();const t=new URLSearchParams({name:deviceNameField.value,lang:deviceLanguageSelect.value,tempUnit:sensorUnitSelect.value,sensorUpdateInterval:sensorUpdateInterval.value,thresholdTemp:sensorThresholdTemp.value,thresholdHumidity:sensorThresholdHumidity.value,thresholdLight:sensorThresholdLight.value,externalSensorSet:externalSetCheckbox.checked?"true":"false",externalSensor:externalSensorSelect.value,buzzerSet:buzzerSetCheckbox.checked?"true":"false",buzzerTune:buzzerTuneSelect.value,buzzerOpening:buzzerOpeningCheckbox.checked?"true":"false",buzzerClosing:buzzerClosingCheckbox.checked?"true":"false",logAccess:accessLoggingCheckbox.checked?"true":"false",logDebug:debugLoggingCheckbox.checked?"true":"false"});try{if(!(await fetch("/api/settings/device",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:savedToken},body:t})).ok)return void console.error("Save failed");showSavedAlert()}catch(e){console.error("Error saving device settings:",e)}}function showSavedAlert(){alertSavedDevice.style.display="block",scrollToTop(),setTimeout((()=>{alertSavedDevice.style.display="none"}),3e3)}function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}function showResetModal(){modalInstance.show()}async function handleReset(){try{if(!(await fetch("/api/reset",{method:"POST",headers:{Authorization:savedToken}})).ok)return void console.error("Reset failed");modalInstance.hide()}catch(e){console.error("Error resetting device:",e)}}function changeLanguage(){const e=deviceLanguageSelect.value;localStorage.setItem("lang",e),loadLanguage(e)}async function downloadDiagnose(e){e.preventDefault();const t=new JSZip,n=[{url:"/api/diagnose",name:"diagnostics.json"},{url:"/api/log/debug",name:"log-debug.txt"},{url:"/api/log/access",name:"log-access.txt"}];for(const e of n){const n=await fetch(e.url);if(!n.ok){console.error(`Failed to fetch ${e.url}`);continue}const o=await n.blob();t.file(e.name,o)}const o=await t.generateAsync({type:"blob"}),a=document.createElement("a");a.href=URL.createObjectURL(o),a.download="PandaGarage-Diagnostics.zip",a.click(),URL.revokeObjectURL(a.href)}