let alertUpdate,dashTemp,dashHum,dashLux,dashStatus,dashPosition,btnUp,btnDown,btnStop,switchLight,btnHalf,btnVent,dashExtCard,dashExtTitle,dashExtVal,dashExtUnit,rowSensor,doorContainer;document.addEventListener("DOMContentLoaded",init);const savedToken=localStorage.getItem("token");async function init(){cacheElements(),bindEvents(),await loadDashboardData(),getDoorUpdates(),checkForUpdates(),doorSVG()}function cacheElements(){alertUpdate=document.getElementById("alert-update"),dashTemp=document.getElementById("dash-temp"),dashHum=document.getElementById("dash-hum"),dashLux=document.getElementById("dash-lux"),dashStatus=document.getElementById("door-status-val"),dashPosition=document.getElementById("door-position-val"),doorContainer=document.getElementById("door-container"),btnUp=document.getElementById("btn-door-up"),btnDown=document.getElementById("btn-door-down"),btnStop=document.getElementById("btn-door-stop"),switchLight=document.getElementById("switch-light"),btnHalf=document.getElementById("btn-door-half"),btnVent=document.getElementById("btn-door-vent"),dashExtCard=document.getElementById("dash-ext-card"),dashExtTitle=document.getElementById("dash-ext-title"),dashExtVal=document.getElementById("dash-ext-val"),dashExtUnit=document.getElementById("dash-ext-unit"),rowSensor=document.getElementById("sensor-row"),alertUpdate.style.display="none"}async function bindEvents(){btnUp.addEventListener("click",(async function(){doorControl("open")})),btnDown.addEventListener("click",(async function(){doorControl("close")})),btnStop.addEventListener("click",(async function(){doorControl("stop")})),switchLight.addEventListener("change",(async function(){lightControl("invert")})),btnHalf.addEventListener("click",(async function(){doorControl("half")})),btnVent.addEventListener("click",(async function(){doorControl("vent")}))}async function loadDashboardData(){try{const t=await fetch("/api/status");if(!t.ok)throw new Error("Response was not ok");const e=await t.json();localStorage.setItem("version_fw",e.version_fw||"0"),updateDashboard(e)}catch(t){console.error("Failed to load dashboard data:",t)}}function updateDashboard(t){void 0!==t.sensor&&(void 0!==t.sensor.temperature&&(dashTemp.textContent=Number(t.sensor.temperature).toFixed(2)),void 0!==t.sensor.humidity&&(dashHum.textContent=Number(t.sensor.humidity).toFixed(2)),void 0!==t.sensor.lux&&(dashLux.textContent=Number(t.sensor.lux).toFixed(2)),void 0!==t.sensor.externalSensor&&("none"==t.sensor.externalSensor?(dashExtCard.style.display="none",rowSensor.classList.remove("row-cols-lg-4"),rowSensor.classList.add("row-cols-lg-3")):(dashExtCard.style.display="block",rowSensor.classList.add("row-cols-lg-4"),rowSensor.classList.remove("row-cols-lg-3"),dashExtTitle.textContent=t.sensor.externalSensor.title,dashExtVal.textContent=t.sensor.externalSensor.val,dashExtUnit.textContent=t.sensor.externalSensor.unit))),void 0!==t.door&&(void 0!==t.door.state?dashStatus.textContent=t.door.state:dashStatus.textContent="not connected",void 0!==t.door.position_current?(dashPosition.textContent=t.door.position_current+"%",buildDoorAnimation(t.door.position_current)):dashPosition.textContent="not connected",void 0!==t.door.light&&(switchLight.checked=!0===t.door.light))}async function doorControl(t){if("open"===t||"close"===t||"stop"===t||"half"===t||"vent"===t)try{const e=new URLSearchParams({action:t});if(!(await fetch("/api/control",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Access-Source":"webui",Authorization:savedToken},body:e})).ok)return void console.error("Door control failed")}catch(t){console.error("API error: ",t)}}async function lightControl(t){let e;"toggle"===t?e=new URLSearchParams({action:"light"}):"invert"==t&&(e=switchLight.checked?new URLSearchParams({action:"light",state:"on"}):new URLSearchParams({action:"light",state:"off"}));try{if(!(await fetch("/api/control",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Access-Source":"webui",Authorization:savedToken},body:e})).ok)return void console.error("Door control failed")}catch(t){console.error("API error: ",t)}}async function getDoorUpdates(){const t=new EventSource("/api/events");t.addEventListener("open",(function(t){console.log("Connected to door updates.")}),!1),t.addEventListener("door",(function(t){updateDashboard(JSON.parse(t.data))}),!1),t.addEventListener("error",(function(t){t.readyState==EventSource.CLOSED&&(console.error("Error connecting to live logs:",t),setTimeout(getDoorUpdates,5e3))}),!1)}async function checkForUpdates(){const t=localStorage.getItem("version_fw")||"0.0.0";try{const e=await fetch("https://api.github.com/repos/derDeno/PandaGarage/releases/latest");e.ok||console.log(`GitHub API returned an error: ${e.status}`);const o=await e.json();isNewerVersion(o.tag_name.replace(/^v/,""),t)&&(alertUpdate.style.display="block")}catch(t){console.error(`Error checking for updates: ${t.message}`)}}function isNewerVersion(t,e){const o=t=>{const[e,o]=t.split("-");return{parts:e.split(".").map(Number),pre:o||""}},n=o(t),r=o(e);for(let t=0;t<Math.max(n.parts.length,r.parts.length);t++){const e=n.parts[t]||0,o=r.parts[t]||0;if(e>o)return!0;if(e<o)return!1}return s=n.pre,a=r.pre,(s||a?s?a?s.localeCompare(a):-1:1:0)>0;var s,a}function doorSVG(){doorContainer.innerHTML='\n\t\t<svg id="garage-door-svg" class="svg-door" width="200" height="200" viewBox="0 0 200 200">\n\t\t\t<rect x="10" y="10" width="180" height="180" fill="#fff" stroke="#212529" stroke-width="4" rx="5" ry="5" />\n\t\t\t<g id="door-panels"></g>\n\t\t</svg>\n\t',buildDoorAnimation()}function buildDoorAnimation(t=0){const e=30.4,o=5*(1-Math.max(0,Math.min(100,t))/100),n=Math.floor(o),r=o-n,s=document.getElementById("door-panels");s.innerHTML="";for(let t=0;t<n;t++){const o=16+34.4*t,n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",16),n.setAttribute("y",o),n.setAttribute("width",168),n.setAttribute("height",e),n.setAttribute("fill","#212529"),s.appendChild(n)}if(r>0&&n<5){const t=16+34.4*n,o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",16),o.setAttribute("y",t),o.setAttribute("width",168),o.setAttribute("height",e*r),o.setAttribute("fill","#212529"),s.appendChild(o)}}