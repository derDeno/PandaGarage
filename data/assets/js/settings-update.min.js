let btnFw,btnFs,selectorFw,selectorFs,modalOta,modalFail,modalSuccess,modalProgressTxt,modalProgressBar;document.addEventListener("DOMContentLoaded",init);const Savedtoken=localStorage.getItem("token");function init(){cacheElements(),bindEvents()}function cacheElements(){btnFw=document.getElementById("ota-upload-fw"),btnFs=document.getElementById("ota-upload-fs"),selectorFw=document.getElementById("ota-selector-fw"),selectorFs=document.getElementById("ota-selector-fs"),modalProgressBar=document.getElementById("ota-progress-bar"),modalOta=new bootstrap.Modal(document.getElementById("modal-ota"),{backdrop:"static",keyboard:!1}),modalFail=new bootstrap.Modal(document.getElementById("modal-ota-failed"),{backdrop:"static",keyboard:!1}),modalSuccess=new bootstrap.Modal(document.getElementById("modal-ota-complete"),{backdrop:"static",keyboard:!1})}function bindEvents(){btnFw.addEventListener("click",btnFwClick),btnFs.addEventListener("click",btnFsClick)}function btnFwClick(){uploadOtaFw()}function btnFsClick(){uploadOtaFs()}async function uploadOtaFw(){showOtaProgress();const o=selectorFw.files[0],e=new FormData;e.append("file",o);try{const o=await fetch("/api/ota/fw",{method:"POST",headers:{Authorization:Savedtoken},body:e});o.ok?console.log(o.text()):(console.error("Error uploading OTA FW file: ",o),showErrorModal())}catch(o){console.error("Error uploading OTA FW file: ",o)}}async function uploadOtaFs(){showOtaProgress();const o=selectorFs.files[0],e=new FormData;e.append("file",o);try{const o=await fetch("/api/ota/fs",{method:"POST",headers:{Authorization:Savedtoken},body:e});o.ok?console.log(o.text()):(console.error("Error uploading OTA FS file: ",o),showErrorModal())}catch(o){console.error("Error uploading OTA FS file: ",o)}}async function showOtaProgress(){if(modalProgressBar.style.width="0%",modalProgressBar.innerText="0%",modalProgressBar.classList.remove("bg-danger"),modalProgressBar.classList.add("bg-success"),modalProgressBar.classList.add("progress-bar-striped"),modalProgressBar.classList.add("progress-bar-animated"),modalOta.show(),window.EventSource){var o=new EventSource("/api/events");o.addEventListener("open",(function(o){console.log("Events Connected")}),!1),o.addEventListener("ota-progress",(function(o){console.log("OTA Progress: "+o.data+"%"),modalProgressBar.style.width=o.data+"%",modalProgressBar.innerText=o.data+"%",modalProgressBar.setAttribute("aria-valuenow",o.data),100==o.data&&(modalProgressBar.classList.remove("progress-bar-striped"),modalProgressBar.classList.remove("progress-bar-animated"),modalOta.hide(),modalSuccess.show(),setTimeout((()=>{window.location.reload()}),8e3))}),!1),o.addEventListener("error",(function(o){o.readyState==EventSource.CLOSED&&(console.error("Connection closed"),modalProgressBar.style.width="100%",modalProgressBar.innerText="Error",modalProgressBar.classList.remove("bg-success"),modalProgressBar.classList.add("bg-danger"),modalProgressBar.classList.remove("progress-bar-striped"),modalProgressBar.classList.remove("progress-bar-animated"),showErrorModal())}),!1)}}function showErrorModal(){modalOta.hide(),modalFail.show(),setTimeout((()=>{window.location.reload()}),8e3)}