let btnFw,btnFs,selectorFw,selectorFs,modalOta,modalFail,modalSuccess,modalProgressTxt,modalProgressBar;document.addEventListener("DOMContentLoaded",init);const Savedtoken=localStorage.getItem("token");function init(){cacheElements(),bindEvents()}function cacheElements(){btnFw=document.getElementById("ota-upload-fw"),btnFs=document.getElementById("ota-upload-fs"),selectorFw=document.getElementById("ota-selector-fw"),selectorFs=document.getElementById("ota-selector-fs"),modalProgressTxt=document.getElementById("ota-progress-txt"),modalProgressBar=document.getElementById("ota-progress-bar"),modalOta=new bootstrap.Modal(document.getElementById("modal-ota")),modalFail=new bootstrap.Modal(document.getElementById("modal-ota-failed")),modalSuccess=new bootstrap.Modal(document.getElementById("modal-ota-complete"))}function bindEvents(){btnFw.addEventListener("click",btnFwClick),btnFs.addEventListener("click",btnFsClick)}function btnFwClick(){uploadOtaFw()}function btnFsClick(){uploadOtaFs()}async function uploadOtaFw(){showOtaProgress();const e=selectorFw.files[0],o=new FormData;o.append("file",e);try{const e=await fetch("/api/ota/fw",{method:"POST",headers:{Authorization:Savedtoken},body:o});e.ok?console.log(e.text()):(console.error("Error uploading OTA FW file: ",e),showErrorModal())}catch(e){console.error("Error uploading OTA FW file: ",e)}}async function uploadOtaFs(){showOtaProgress();const e=selectorFs.files[0],o=new FormData;o.append("file",e);try{const e=await fetch("/api/ota/fs",{method:"POST",headers:{Authorization:Savedtoken},body:o});e.ok?console.log(e.text()):(console.error("Error uploading OTA FS file: ",e),showErrorModal())}catch(e){console.error("Error uploading OTA FS file: ",e)}}async function showOtaProgress(){if(modalProgressTxt.innerText="",modalProgressBar.style.width="0%",modalProgressBar.innerText="0%",modalProgressBar.classList.remove("bg-danger"),modalProgressBar.classList.add("bg-success"),modalProgressBar.classList.add("progress-bar-striped"),modalProgressBar.classList.add("progress-bar-animated"),modalOta.show(),window.EventSource){var e=new EventSource("/api/events");e.addEventListener("open",(function(e){console.log("Events Connected")}),!1),e.addEventListener("ota-progress",(function(e){console.log("OTA Progress: "+e.data+"%"),modalProgressBar.style.width=e.data+"%",modalProgressBar.innerText=e.data+"%",modalProgressBar.setAttribute("aria-valuenow",e.data),100==e.data&&(modalProgressBar.classList.remove("progress-bar-striped"),modalProgressBar.classList.remove("progress-bar-animated"),modalOta.hide(),modalSuccess.show(),setTimeout((()=>{window.location.reload()}),8e3))}),!1),e.addEventListener("error",(function(e){e.readyState==EventSource.CLOSED&&(console.error("Connection closed"),modalProgressBar.style.width="100%",modalProgressBar.innerText="Error",modalProgressBar.classList.remove("bg-success"),modalProgressBar.classList.add("bg-danger"),modalProgressBar.classList.remove("progress-bar-striped"),modalProgressBar.classList.remove("progress-bar-animated"),showErrorModal())}),!1)}}function showErrorModal(){modalOta.hide(),modalFail.show(),setTimeout((()=>{window.location.reload()}),8e3)}