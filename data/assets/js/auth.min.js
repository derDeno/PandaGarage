document.addEventListener("DOMContentLoaded",(function(){if(window.location.pathname.startsWith("/auth"))init();else{let e=localStorage.getItem("token");null!==e?verifyToken(e):authRedirect()}}));let alertAuth,alertPassword,passwordField,loginBtn,redirectUrl="/";function init(){cacheElements(),bindEvents(),hideAlerts();new URLSearchParams(window.location.search).has("r")&&(alertAuth.style.display="block",alertAuth.classList.remove("shake-x"),alertAuth.offsetWidth,alertAuth.classList.add("shake-x"))}function cacheElements(){alertAuth=document.getElementById("alert-no-auth"),alertPassword=document.getElementById("alert-wrong-password"),passwordField=document.getElementById("auth_login"),loginBtn=document.getElementById("btn-login")}function bindEvents(){loginBtn.addEventListener("click",login)}async function login(e){if(e.preventDefault(),""===passwordField.value)return alertPassword.style.display="block",alertPassword.classList.remove("shake-x"),alertPassword.offsetWidth,alertPassword.classList.add("shake-x"),void(alertAuth.style.display="none");hideAlerts();const t=await fetch("/api/auth/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({pwd:passwordField.value})});if(!t.ok)return alertPassword.style.display="block",alertPassword.classList.remove("shake-x"),alertPassword.offsetWidth,alertPassword.classList.add("shake-x"),void(passwordField.value="");const a=await t.json(),o=new URLSearchParams(window.location.search);redirectUrl=o.has("r")?o.get("r"):"/",localStorage.setItem("token",a.token),localStorage.setItem("lastAuthCheck",Date.now().toString()),window.location.href=redirectUrl}function hideAlerts(){alertAuth.style.display="none",alertPassword.style.display="none"}async function verifyToken(e){const t=parseInt(localStorage.getItem("lastAuthCheck")||"0",10);if(Date.now()-t<3e5)return;const a=await fetch("/api/auth",{method:"POST",headers:{Authorization:e}});if(!a.ok)return void authRedirect();const o=await a.json();localStorage.setItem("token",o.token),localStorage.setItem("lastAuthCheck",Date.now().toString())}function authRedirect(){window.location.href="/auth?r="+encodeURIComponent(window.location.pathname)}